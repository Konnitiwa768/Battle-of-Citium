<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZpDIC 派生ツール 完全逐次処理版</title>
<style>
body{font-family:sans-serif;margin:20px;background:#f5f5f5;}
input,textarea,select,button{display:block;margin:8px 0;padding:6px;width:100%;max-width:500px;}
textarea{height:80px;}
pre{background:#fff;padding:10px;max-width:800px;overflow:auto;}
</style>
</head>
<body>
<h1>ZpDIC 派生ツール【安全逐次処理版】</h1>

<label>APIキー:</label><input id="apiKey">
<label>搬入口辞書ID:</label><input id="inputDict">
<label>搬出口辞書ID:</label><input id="outputDict">
<label>単語番号範囲（例: 1-500）:</label><input id="wordRange">

<h2>派生ルール</h2>
<textarea id="derivationRules" placeholder="d→t\na→e など改行区切り"></textarea>

<button onclick="runDerivation()">派生開始</button>
<pre id="progress"></pre>

<script>
const apiBase='https://zpdic.ziphil.com/api/v0';
function getHeaders(){return {'Content-Type':'application/json','X-Api-Key':document.getElementById('apiKey').value};}

function applyRules(text,rules){
  let res=text;
  for(const rule of rules){
    const [from,to]=rule.split('→').map(s=>s.trim());
    if(from)res=res.replace(new RegExp(from,'g'),to);
  }
  return res;
}

async function runDerivation(){
  const apiKey=document.getElementById('apiKey').value.trim();
  const inId=document.getElementById('inputDict').value.trim();
  const outId=document.getElementById('outputDict').value.trim();
  const [start,end]=document.getElementById('wordRange').value.trim().split('-').map(Number);
  const rules=document.getElementById('derivationRules').value.trim().split('\n').filter(Boolean);
  
  if(!apiKey||!inId||!outId||isNaN(start)||isNaN(end)||rules.length===0){
    alert('すべて入力してください');
    return;
  }

  for(let i=start;i<=end;i++){
    document.getElementById('progress').textContent=`${i-start+1} / ${end-start+1} 処理中（単語番号: ${i}）`;

    try{
      const res=await fetch(`${apiBase}/dictionary/${inId}/word/${i}`,{headers:getHeaders()});
      if(!res.ok){
        document.getElementById('progress').textContent+=`\n単語${i}の取得失敗(${res.status}) スキップ`;
        continue;
      }
      const w=(await res.json()).word;

      const newName=applyRules(w.name,rules);
      const newPron=applyRules(w.pronunciation||'',rules);
      const newInfos=(w.informations||[]).map(inf=>({title:applyRules(inf.title,rules),text:applyRules(inf.text,rules)}));

      const body={word:{
        name:newName,pronunciation:newPron,
        equivalents:w.equivalents,
        tags:w.tags,
        informations:newInfos,
        variations:w.variations,
        relations:w.relations
      }};

      const postRes=await fetch(`${apiBase}/dictionary/${outId}/word`,{
        method:'POST',
        headers:getHeaders(),
        body:JSON.stringify(body)
      });
      if(postRes.ok){
        document.getElementById('progress').textContent+=`\n単語${i}派生完了`;
      }else{
        document.getElementById('progress').textContent+=`\n単語${i}派生失敗(${postRes.status})`;
      }
    }catch(e){
      document.getElementById('progress').textContent+=`\n単語${i}処理中にエラー発生 スキップ`;
      console.error(e);
    }

    await new Promise(r=>setTimeout(r,500)); // 次の単語まで待機
  }

  alert('✅ 派生処理 完了');
}
</script>
</body>
</html>
